{% extends 'base.html' %}

{% block title %}{{ quiz.title }} | QuizMaster{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">{{ quiz.title }}</h2>
    <span class="badge bg-primary rounded-pill">{{ quiz.category }}</span>
  </div>

  <form method="post" id="quizForm" novalidate>
    {% csrf_token %}
    
        <div class="card mb-4">
      <div class="card-header bg-light">
        <div class="d-flex justify-content-between">
          <span>Question <span id="currentQuestion">1</span>/10</span>
          <span class="text-muted" id="timer">00:00</span>
        </div>
        <div class="progress mt-2" style="height: 5px;">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
      </div>

      
      <div class="card-body p-4">
        <div class="progress mb-3" style="height: 8px;">
          <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        
        {% for field in form %}
        <div class="question-container mb-4" data-question-index="{{ forloop.counter0 }}" style="display: none;">
          <h5 class="mb-3">{{ field.label }}</h5>
          <div class="ps-4">
            {% for choice in field %}
            <div class="form-check mb-2">
              {{ choice.tag }}
              <label class="form-check-label" for="{{ choice.id_for_label }}" style="cursor: pointer;">
                {{ choice.choice_label }}
              </label>
            </div>
            {% endfor %}
          </div>
          {% if field.errors %}
            <div class="alert alert-danger mt-2 p-2" role="alert">
              {{ field.errors|join:", " }}
            </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      
      <div class="card-footer bg-light d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" id="prevBtn" disabled>
          <i class="bi bi-arrow-left me-1"></i> Previous
        </button>
        <div class="text-muted small" id="feedback" role="status"></div>
        <button type="submit" class="btn btn-success px-4" id="submitBtn" style="display: none;">
          Submit Quiz <i class="bi bi-check2 ms-1"></i>
        </button>
        <button type="button" class="btn btn-primary" id="nextBtn">
          Next <i class="bi bi-arrow-right ms-1"></i>
        </button>
      </div>
    </div>
  </form>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const questions = document.querySelectorAll('.question-container');
  const totalQuestions = questions.length;
  let currentQuestion = 0;
  let quizDuration = 0;
  let timerInterval;

  // Timer function
  function startTimer() {
    timerInterval = setInterval(function() {
      quizDuration++;
      const minutes = Math.floor(quizDuration / 60).toString().padStart(2, '0');
      const seconds = (quizDuration % 60).toString().padStart(2, '0');
      document.getElementById('timer').textContent = `${minutes}:${seconds}`;
    }, 1000);
  }

  // Show question function with accessibility
  function showQuestion(index) {
    questions.forEach((q, i) => {
      q.style.display = i === index ? 'block' : 'none';
    });
    document.getElementById('currentQuestion').textContent = index + 1;
    document.getElementById('progressBar').style.width = `${((index + 1) / totalQuestions) * 100}%`;
    document.getElementById('progressBar').setAttribute('aria-valuenow', ((index + 1) / totalQuestions) * 100);

    // Button controls
    document.getElementById('prevBtn').disabled = index === 0;
    document.getElementById('nextBtn').style.display = index === totalQuestions - 1 ? 'none' : 'block';
    document.getElementById('submitBtn').style.display = index === totalQuestions - 1 ? 'inline-flex' : 'none';
    document.getElementById('feedback').textContent = '';

    // Focus on the first radio button
    const currentQuestionElement = questions[index];
    const firstInput = currentQuestionElement.querySelector('input[type="radio"]');
    if (firstInput) firstInput.focus();
  }

  // Navigation controls
  document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentQuestion > 0) {
      showQuestion(--currentQuestion);
    }
  });

  document.getElementById('nextBtn').addEventListener('click', () => {
    const currentField = questions[currentQuestion];
    const inputs = currentField.querySelectorAll('input[type="radio"]');
    const isChecked = Array.from(inputs).some(input => input.checked);

    if (!isChecked) {
      document.getElementById('feedback').textContent = 'Please select an answer before proceeding.';
      return;
    }

    if (currentQuestion < totalQuestions - 1) {
      showQuestion(++currentQuestion);
    }
  });

  // Initialize
  showQuestion(0);
  startTimer();

  // Clean up timer on form submit
  document.getElementById('quizForm').addEventListener('submit', function(event) {
    const currentField = questions[currentQuestion];
    const inputs = currentField.querySelectorAll('input[type="radio"]');
    const isChecked = Array.from(inputs).some(input => input.checked);

    if (!isChecked) {
      event.preventDefault();
      document.getElementById('feedback').textContent = 'Please select an answer before submitting.';
    } else {
      clearInterval(timerInterval);
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', (event) => {
    if (event.key === 'ArrowLeft' && !document.getElementById('prevBtn').disabled) {
      document.getElementById('prevBtn').click();
    } else if (event.key === 'ArrowRight' && document.getElementById('nextBtn').style.display !== 'none') {
      document.getElementById('nextBtn').click();
    }
  });
});
</script>
{% endblock %}
{% endblock %}